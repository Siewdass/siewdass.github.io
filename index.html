<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BITCOIN TRADER</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap" rel="stylesheet">
		<style>
			body {
				background: #6B728E;
				font-family: 'Ubuntu', sans-serif;
				margin-bottom: 15px;
			}
			.navbar {
				height: 50px !important;
			}
			#navbar {
				height: 50px !important;
				background: #404258 !important;
				border-bottom-left-radius: 6px;
    		border-bottom-right-radius: 6px;
			}
			.navbar-brand {
				color: white;
				font-size: 17px;
				font-weight: bold;
			}
			.navbar-brand:hover {
				color: white;
			}
			#chart {
				background: #50577A;
				border-bottom-left-radius: 6px;
    		border-bottom-right-radius: 6px;
			}
			.list-group {
				border-top-left-radius: 0px !important;
    		border-top-right-radius: 0px !important;
			}
			.list-group-item {
				color: white;
				background: #50577A;
			}
			#header {
				margin-top: 15px;
				border-top-left-radius: 6px;
    		border-top-right-radius: 6px;
				background: #404258 !important;
			}
		</style>
		<style>
		</style>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.0/dist/chart.umd.min.js"></script>
  </head>
<body>

	<div class="container">
		<nav id="navbar" class="navbar navbar-expand-lg navbar-light bg-dark">
			<a class="navbar-brand mx-auto align-middle">BITCOIN TRADER</a>
		</nav>

		<nav id="header" class="navbar navbar-expand-lg navbar-light bg-dark">
			<a class="navbar-brand mx-auto">OWNER</a>
		</nav>
		<ul class="list-group">
			<li id="total" class="list-group-item">Amount: 0.00 $</li>
			<li id="algorithm" class="list-group-item">Algorithm: Unknow</li-->
			<li id="time" class="list-group-item">Time: 00d 00h 00m 00s</li>
		</ul>

		<nav id="header" class="navbar navbar-expand-lg navbar-light bg-dark">
			<a class="navbar-brand mx-auto">INDICATORS</a>
		</nav>
		<ul class="list-group">
			<li id="price" class="list-group-item">Price: 0.00 $</li>
		</ul>

		<nav id="header" class="navbar navbar-expand-lg navbar-light bg-dark">
			<a class="navbar-brand mx-auto">GRAPH</a>
		</nav>
		<canvas id="chart"></canvas>

		<nav id="header" class="navbar navbar-expand-lg navbar-light bg-dark">
			<a class="navbar-brand mx-auto">ORDER</a>
		</nav>
		<ul class="list-group">
			<li id="status" class="list-group-item">Status: Waiting</li>
			<li id="buyedat" class="list-group-item">Buyed at: 0.00 $</li>
			<li id="selledat" class="list-group-item">Selled at: 0.00 $</li>
			<li id="orders" class="list-group-item">Orders: 0</li>
		</ul>
	</div>

	<script>
		String.prototype.capitalize = function(  ) {
			return this[ 0 ].toUpperCase( ) + this.slice( 1 )
		}

		Number.prototype.characters = function( ) {
			return this.toString( ).length == 1 ? '0' + this.toString( ) : this.toString( )
		}

		const CHART = document.getElementById( 'chart' )
		const PRICE = document.getElementById( 'price' )
		const AMOUNT = document.getElementById( 'total' )
		//const PROFIT = document.getElementById( 'profit' )
		const STATUS = document.getElementById( 'status' )
		const BUYEDAT = document.getElementById( 'buyedat' )
		const SELLEDAT = document.getElementById( 'selledat' )
		const ORDERS = document.getElementById( 'orders' )
		const TIME = document.getElementById( 'time' )
		const ALGORITHM = document.getElementById( 'algorithm' )

		let amount = 100.00
		let orders = 0
		let price
		let active = false
		
		AMOUNT.innerHTML = `Amount: ${amount.toFixed( 2 )} $`

		const data = {
			labels: [ ],
			datasets: [ {
				lineTension: 0.3,
				data: [ ],
				segment: {
					borderColor: ( ctx ) => {
						return ctx.p0.parsed.y > ctx.p1.parsed.y ? 'red' : 'cyan'
					}
				}
			} ]
		}

		const options = {
			animation: { x: {  duration: 100 }, y: {  duration: 0 } },
			plugins: { legend: { display: false } },
			scales: { y: { display: false }, x: { display: false } },
			fill: false,
			interaction: { intersect: false },
			radius: 0
		}

		let chart = new Chart( CHART, { type: 'line', data, options } )

		class Trader {

			algorithm = ''
			old = 0
			upCount = 0
			downCount = 0
			drop = 0
			rise = 0

			constructor( algorithm ) {
				this.algorithm = algorithm
				ALGORITHM.innerHTML = `Algorithm: ${algorithm.capitalize( )}`
			}

			canBuy( price ) {
				if ( this.algorithm == 'mercury' ) {

					if ( price > this.old ) {
						this.rise += 1
						if ( this.rise >= 16 ) {
							this.rise = 0
							return true
						}
					} else if ( price < this.old ) {
						this.rise = 0
					}
					this.old = price
					return false

				} else if ( this.algorithm == 'venus' ) {

					if ( this.drop >= 150 ) {
						if ( price > this.old ) {
							this.upCount += 1
							if ( this.upCount >= 17 ) {
								this.upCount = 0
								this.downCount = 0
								this.drop = 0
								return true
							}
						} else {
							this.upCount = 0
						}
					} else if ( price < this.old ) { 
						this.drop += 1
						this.rise = 0
					} else if ( this.rise < 10 ) {
						this.rise += 1
						this.drop -= 3
					} else {
						this.rise = 0
						this.drop = 0
					}
					console.log( this.drop, this.rise )
					this.old = price
					return false

				}
			}

			canSell( price ) {
				if ( this.algorithm == 'mercury' ) {

					if ( price < this.old ) {
						this.drop += 1
						if ( this.drop >= 6 ) {
							this.drop = 0
							return true
						}
					} else if ( price < this.old ) {
						this.drop = 0
					}
					this.old = price
					return false

				} else if ( this.algorithm == 'venus' ) { 

					if ( price < this.old ) {
						this.downCount += 1
						if ( this.downCount >= 4 ) {
							this.upCount = 0
							this.downCount = 0
							return true
						}
					}
					this.old = price
					return false
				}

			}

		}

		class Order {
			old = 0
			makerBuy( price ) {
				STATUS.innerHTML = `Status: Buyed`
				BUYEDAT.innerHTML = `Buyed at: ${price} $`
				SELLEDAT.innerHTML = `Selled at: 0.00 $`
				this.old = price
			}
			makerSell( price ) {
				STATUS.innerHTML = `Status: Selled`
				SELLEDAT.innerHTML = `Selled at: ${price} $`
				let percent = ( ( price - this.old ) / price ) * 100
				amount += ( percent / amount ) * 100
				AMOUNT.innerHTML = `Amount: ${amount.toFixed( 2 )} $`
				orders += 1
				ORDERS.innerHTML = `Orders: ${orders}`
			}
		}

		const trader = new Trader( 'mercury' )
		const order = new Order( )

		setInterval( async function( ) {
			try {
				const res = await fetch( 'https://api.binance.com/api/v3/avgPrice?symbol=BTCUSDT' )
				const data = await res.json( )
				price = parseFloat( data.price )

				if ( !active ) {
					if ( trader.canBuy( price ) ) {
						order.makerBuy( price )
						active = true
					}
				} else {
					if ( trader.canSell( price ) ) {
						order.makerSell( price )
						active = false
					}
				}

				chart.data.datasets[ 0 ].data.push( price )
				chart.data.labels.push( new Date( ).getTime( ) )
				if ( chart.data.datasets[ 0 ].data.length > 31 ) {
					chart.data.datasets[ 0 ].data.shift( )
					chart.data.labels.shift( )
				}
				PRICE.innerHTML = `Price: ${price} $`
				chart.update( )
			} catch { }
		}, 500 )

		function convert( value ) {
			const x = value.toString()
			return x.length == 1 ? '0' + x : x
		}

		let days = 0, hours = 0, minutes = 0, seconds = 0
		setInterval( function( ) {
			seconds += 1
			if ( seconds >= 60 ) {
				seconds = 0
				minutes += 1
			}
			if ( minutes >= 60 ) {
				minutes = 0
				hours += 1
			}
			if ( hours >= 24 ) {
				hours = 0
				days += 1
			}
			TIME.innerHTML = `Time: ${days.characters( )}d ${hours.characters( )}h ${minutes.characters( )}m ${seconds.characters( )}s`
		}, 1000 )

		/*const btc = new WebSocket( 'wss://stream.binance.com:9443/ws/btcusdt@trade' )
		let buyers = 0, sellers = 0
		btc.onmessage = async function( message ) {
			const { p, m, E } = JSON.parse( message.data )
		}*/
	</script>
</body>
</html>


